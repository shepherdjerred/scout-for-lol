VERSION 0.8

deps:
  FROM ../../+deno
  WORKDIR /workspace/packages/backend

  COPY ../data+src/ /workspace/packages/data/

  # download and cache dependencies
  CACHE --persist $DENO_DIR
  COPY --dir deno* src .
  RUN deno cache src/index.ts

check:
  FROM +deps
  CACHE $DENO_DIR
  RUN deno check src/index.ts
  RUN deno lint
  # RUN deno test -A --unstable

image:
  ARG --required git_sha
  ARG --required version
  FROM +deps
  ENV VERSION=$version
  ENV GIT_SHA=$git_sha

  ENTRYPOINT deno run -A --unstable-ffi src/index.ts
  HEALTHCHECK  --interval=30s --timeout=5s --start-period=5s --retries=3 CMD deno run -A /workspace/packages/backend/src/health.ts || exit 1
  SAVE IMAGE --push ghcr.io/shepherdjerred/scout-for-lol:$version
  SAVE IMAGE --push ghcr.io/shepherdjerred/scout-for-lol:$git_sha
