VERSION 0.8
FROM ../../+deno

prisma.generate:
  # this command fails if node isn't installed
  FROM ../report+deno-node
  RUN apt install -y openssl
  COPY --dir deno.json deno.lock .
  COPY --dir generate.ts prisma .
  RUN deno run -A generate.ts
  # delete some files that are unneeded and that deno stuggled with
  RUN rm generated/client/runtime/edge-esm.cjs
  SAVE ARTIFACT generated/

deps:
  # for Prisma
  RUN apt update && apt install -y openssl
  WORKDIR /workspace/packages/backend

  COPY ../data+src/ /workspace/packages/data/src/
  COPY ../report+src/ /workspace/packages/report/src/
  COPY +prisma.generate/ .

  # download and cache dependencies
  CACHE --persist $DENO_DIR
  COPY --dir deno* src .
  RUN deno cache src/index.ts

check:
  FROM +deps
  CACHE $DENO_DIR
  RUN deno check src/index.ts
  RUN deno lint
  COPY test.env .env
  RUN deno test -A --unstable

image:
  ARG --required git_sha
  ARG --required version
  FROM +deps
  ENV VERSION=$version
  ENV GIT_SHA=$git_sha

  ENTRYPOINT deno run -A --unstable-ffi src/index.ts
  HEALTHCHECK  --interval=30s --timeout=5s --start-period=5s --retries=3 CMD deno run -A /workspace/packages/backend/src/health.ts || exit 1
  SAVE IMAGE --push ghcr.io/shepherdjerred/scout-for-lol:$version
  SAVE IMAGE --push ghcr.io/shepherdjerred/scout-for-lol:$git_sha
