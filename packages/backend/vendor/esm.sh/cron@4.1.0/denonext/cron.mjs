/* esm.sh - cron@4.1.0 */
import*as __0$ from"node:child_process";import*as __1$ from"/luxon@~3.5.0?target=denonext";var require=n=>{const e=m=>typeof m.default<"u"?m.default:m,c=m=>Object.assign({__esModule:true},m);switch(n){case"node:child_process":return e(__0$);case"luxon":return c(__1$);default:console.error('module "'+n+'" not found');return null;}};
var q=Object.create;var F=Object.defineProperty;var Y=Object.getOwnPropertyDescriptor;var Z=Object.getOwnPropertyNames;var G=Object.getPrototypeOf,V=Object.prototype.hasOwnProperty;var U=(c=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(c,{get:(e,i)=>(typeof require<"u"?require:e)[i]}):c)(function(c){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+c+'" is not supported')});var D=(c,e)=>()=>(e||c((e={exports:{}}).exports,e),e.exports);var K=(c,e,i,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let t of Z(e))!V.call(c,t)&&t!==i&&F(c,t,{get:()=>e[t],enumerable:!(n=Y(e,t))||n.enumerable});return c};var B=(c,e,i)=>(i=c!=null?q(G(c)):{},K(e||!c||!c.__esModule?F(i,"default",{value:c,enumerable:!0}):i,c));var W=D(f=>{"use strict";Object.defineProperty(f,"__esModule",{value:!0});f.RE_RANGE=f.RE_WILDCARDS=f.PRESETS=f.TIME_UNITS_LEN=f.TIME_UNITS=f.TIME_UNITS_MAP=f.ALIASES=f.PARSE_DEFAULTS=f.CONSTRAINTS=void 0;f.CONSTRAINTS=Object.freeze({second:[0,59],minute:[0,59],hour:[0,23],dayOfMonth:[1,31],month:[1,12],dayOfWeek:[0,7]});f.PARSE_DEFAULTS=Object.freeze({second:"0",minute:"*",hour:"*",dayOfMonth:"*",month:"*",dayOfWeek:"*"});f.ALIASES=Object.freeze({jan:1,feb:2,mar:3,apr:4,may:5,jun:6,jul:7,aug:8,sep:9,oct:10,nov:11,dec:12,sun:0,mon:1,tue:2,wed:3,thu:4,fri:5,sat:6});f.TIME_UNITS_MAP=Object.freeze({SECOND:"second",MINUTE:"minute",HOUR:"hour",DAY_OF_MONTH:"dayOfMonth",MONTH:"month",DAY_OF_WEEK:"dayOfWeek"});f.TIME_UNITS=Object.freeze(Object.values(f.TIME_UNITS_MAP));f.TIME_UNITS_LEN=f.TIME_UNITS.length;f.PRESETS=Object.freeze({"@yearly":"0 0 0 1 1 *","@monthly":"0 0 0 1 * *","@weekly":"0 0 0 * * 0","@daily":"0 0 0 * * *","@hourly":"0 0 * * * *","@minutely":"0 * * * * *","@secondly":"* * * * * *","@weekdays":"0 0 0 * * 1-5","@weekends":"0 0 0 * * 0,6"});f.RE_WILDCARDS=/\*/g;f.RE_RANGE=/^(\d+)(?:-(\d+))?(?:\/(\d+))?$/g});var A=D(S=>{"use strict";Object.defineProperty(S,"__esModule",{value:!0});S.ExclusiveParametersError=S.CronError=void 0;var y=class extends Error{};S.CronError=y;var R=class extends y{constructor(e,i){super(`You can't specify both ${e} and ${i}`)}};S.ExclusiveParametersError=R});var v=D(g=>{"use strict";Object.defineProperty(g,"__esModule",{value:!0});g.CronTime=void 0;var w=U("luxon"),d=W(),m=A(),I=class c{constructor(e,i,n){if(this.realDate=!1,this.second={},this.minute={},this.hour={},this.dayOfMonth={},this.month={},this.dayOfWeek={},i!=null&&n!=null)throw new m.ExclusiveParametersError("timeZone","utcOffset");if(i){if(!w.DateTime.fromObject({},{zone:i}).isValid)throw new m.CronError("Invalid timezone.");this.timeZone=i}n!=null&&(this.utcOffset=n),e instanceof Date||e instanceof w.DateTime?(this.source=e instanceof Date?w.DateTime.fromJSDate(e):e,this.realDate=!0):(this.source=e,this._parse(this.source))}static validateCronExpression(e){try{return new c(e),{valid:!0}}catch(i){return{valid:!1,error:i}}}_getWeekDay(e){return e.weekday===7?0:e.weekday}sendAt(e){let i=this.realDate&&this.source instanceof w.DateTime?this.source:w.DateTime.local();if(this.timeZone&&(i=i.setZone(this.timeZone)),this.utcOffset!==void 0){let n=this.utcOffset<0?"-":"+",t=Math.trunc(this.utcOffset/60),o=String(Math.abs(t)).padStart(2,"0"),h=Math.abs(this.utcOffset-t*60),s=String(h).padStart(2,"0"),u=`UTC${n}${o}:${s}`;if(i=i.setZone(u),!i.isValid)throw new m.CronError("ERROR: You specified an invalid UTC offset.")}if(this.realDate){if(w.DateTime.local()>i)throw new m.CronError("WARNING: Date in past. Will never be fired.");return i}if(e===void 0||isNaN(e)||e<0)return this.getNextDateFrom(i);{let n=[];for(;e>0;e--)i=this.getNextDateFrom(i),n.push(i);return n}}getTimeout(){return Math.max(-1,this.sendAt().toMillis()-w.DateTime.local().toMillis())}toString(){return this.toJSON().join(" ")}toJSON(){return d.TIME_UNITS.map(e=>this._wcOrAll(e))}getNextDateFrom(e,i){var n;e instanceof Date&&(e=w.DateTime.fromJSDate(e));let t=e,o=e.toMillis();if(i&&(t=t.setZone(i)),this.realDate||t.millisecond>0&&(t=t.set({millisecond:0,second:t.second+1})),!t.isValid)throw new m.CronError("ERROR: You specified an invalid date.");let h=w.DateTime.now().plus({years:8});for(;;){let s=t.toMillis()-e.toMillis();if(t>h)throw new m.CronError(`Something went wrong. No execution date was found in the next 8 years.
							Please provide the following string if you would like to help debug:
							Time Zone: ${(n=i?.toString())!==null&&n!==void 0?n:'""'} - Cron String: ${this.source.toString()} - UTC offset: ${t.offset} - current Date: ${w.DateTime.local().toString()}`);if(!(t.month in this.month)&&Object.keys(this.month).length!==12){if(t=t.plus({months:1}),t=t.set({day:1,hour:0,minute:0,second:0}),this._forwardDSTJump(0,0,t)){let[u,r]=this._findPreviousDSTJump(t);if(t=r,u)break}continue}if(!(t.day in this.dayOfMonth)&&Object.keys(this.dayOfMonth).length!==31&&!(this._getWeekDay(t)in this.dayOfWeek&&Object.keys(this.dayOfWeek).length!==7)){if(t=t.plus({days:1}),t=t.set({hour:0,minute:0,second:0}),this._forwardDSTJump(0,0,t)){let[u,r]=this._findPreviousDSTJump(t);if(t=r,u)break}continue}if(!(this._getWeekDay(t)in this.dayOfWeek)&&Object.keys(this.dayOfWeek).length!==7&&!(t.day in this.dayOfMonth&&Object.keys(this.dayOfMonth).length!==31)){if(t=t.plus({days:1}),t=t.set({hour:0,minute:0,second:0}),this._forwardDSTJump(0,0,t)){let[u,r]=this._findPreviousDSTJump(t);if(t=r,u)break}continue}if(!(t.hour in this.hour)&&Object.keys(this.hour).length!==24){let u=t.hour===23&&s>864e5?0:t.hour+1,r=t.minute;if(t=t.set({hour:u}),t=t.set({minute:0,second:0}),this._forwardDSTJump(u,r,t)){let[l,a]=this._findPreviousDSTJump(t);if(t=a,l)break}continue}if(!(t.minute in this.minute)&&Object.keys(this.minute).length!==60){let u=t.minute===59&&s>36e5?0:t.minute+1,r=t.hour+(u===60?1:0);if(t=t.set({minute:u}),t=t.set({second:0}),this._forwardDSTJump(r,u,t)){let[l,a]=this._findPreviousDSTJump(t);if(t=a,l)break}continue}if(!(t.second in this.second)&&Object.keys(this.second).length!==60){let u=t.second===59&&s>6e4?0:t.second+1,r=t.minute+(u===60?1:0),l=t.hour+(r===60?1:0);if(t=t.set({second:u}),this._forwardDSTJump(l,r,t)){let[a,O]=this._findPreviousDSTJump(t);if(t=O,a)break}continue}if(t.toMillis()===o){let u=t.second+1,r=t.minute+(u===60?1:0),l=t.hour+(r===60?1:0);if(t=t.set({second:u}),this._forwardDSTJump(l,r,t)){let[a,O]=this._findPreviousDSTJump(t);if(t=O,a)break}continue}break}return t}_findPreviousDSTJump(e){var i;let n,t,o,h,s=e,u=60*24,r=0;do{if(++r>u)throw new m.CronError(`ERROR: This DST checking related function assumes the input DateTime (${(i=e.toISO())!==null&&i!==void 0?i:e.toMillis()}) is within 24 hours of a DST jump.`);n=s.minute-1,t=s.hour,n<0&&(n+=60,t=(t+24-1)%24),s=s.minus({minute:1}),o=s.minute,h=s.hour}while(n===o&&t===h);let l=s.plus({minute:1}).set({second:0,millisecond:0}),a=l.minus({second:1});return e.month in this.month&&e.day in this.dayOfMonth&&this._getWeekDay(e)in this.dayOfWeek?[this._checkTimeInSkippedRange(a,l),l]:[!1,l]}_checkTimeInSkippedRange(e,i){let n=(e.minute+1)%60,t=(e.hour+(n===0?1:0))%24,o=i.hour-t+1,h=n===0&&i.minute===0;return o===2&&h?t in this.hour:o===1?t in this.hour&&this._checkTimeInSkippedRangeSingleHour(n,i.minute):this._checkTimeInSkippedRangeMultiHour(t,n,i.hour,i.minute)}_checkTimeInSkippedRangeSingleHour(e,i){for(let n=e;n<i;++n)if(n in this.minute)return!0;return i in this.minute&&0 in this.second}_checkTimeInSkippedRangeMultiHour(e,i,n,t){if(e>=n)throw new m.CronError(`ERROR: This DST checking related function assumes the forward jump starting hour (${e}) is less than the end hour (${n})`);let o=Array.from({length:60-i},(r,l)=>i+l),h=Array.from({length:t},(r,l)=>l),s=Array.from({length:60},(r,l)=>l),u=r=>r===e?o:r===n?h:s;for(let r=e;r<=n;++r){if(!(r in this.hour))continue;let l=u(r);for(let a of l)if(a in this.minute)return!0}return n in this.hour&&t in this.minute&&0 in this.second}_forwardDSTJump(e,i,n){let t=n.hour,o=n.minute,h=e%24<t,s=i%60<o;return h||s}_wcOrAll(e){if(this._hasAll(e))return"*";let i=[];for(let n in this[e])i.push(n);return i.join(",")}_hasAll(e){let i=d.CONSTRAINTS[e],n=i[0],t=e===d.TIME_UNITS_MAP.DAY_OF_WEEK?i[1]-1:i[1];for(let o=n,h=t;o<h;o++)if(!(o in this[e]))return!1;return!0}_parse(e){var i;e=e.toLowerCase(),Object.keys(d.PRESETS).includes(e)&&(e=d.PRESETS[e]),e=e.replace(/[a-z]{1,3}/gi,o=>{if(Object.keys(d.ALIASES).includes(o))return d.ALIASES[o].toString();throw new m.CronError(`Unknown alias: ${o}`)});let n=e.trim().split(/\s+/);if(n.length<d.TIME_UNITS_LEN-1)throw new m.CronError("Too few fields");if(n.length>d.TIME_UNITS_LEN)throw new m.CronError("Too many fields");let t=n.length;for(let o of d.TIME_UNITS){let h=d.TIME_UNITS.indexOf(o),s=(i=n[h-(d.TIME_UNITS_LEN-t)])!==null&&i!==void 0?i:d.PARSE_DEFAULTS[o];this._parseField(s,o)}}_parseField(e,i){let n=this[i],t,o=d.CONSTRAINTS[i],h=o[0],s=o[1];e.split(",").forEach(l=>{let a=l.indexOf("*");if(a!==-1&&a!==0)throw new m.CronError(`Field (${l}) has an invalid wildcard expression`)}),e=e.replace(d.RE_WILDCARDS,`${h}-${s}`);let r=e.split(",");for(let l of r){let a=[...l.matchAll(d.RE_RANGE)][0];if(a?.[1]!==void 0){let[,O,P,C]=a,p=parseInt(O,10),_=P!==void 0?parseInt(P,10):void 0,z=C!==void 0,J=parseInt(C??"1",10);if(J===0)throw new m.CronError(`Field (${i}) has a step of zero`);if(_!==void 0&&p>_)throw new m.CronError(`Field (${i}) has an invalid range`);if(p<h||_!==void 0&&_>s||_===void 0&&p>s)throw new m.CronError(`Field value (${e}) is out of range`);p=Math.min(Math.max(h,~~Math.abs(p)),s),_!==void 0?_=Math.min(s,~~Math.abs(_)):_=z?s:p,t=p;do n[t]=!0,t+=J;while(t<=_);i==="dayOfWeek"&&(!n[0]&&n[7]&&(n[0]=n[7]),delete n[7])}else throw new m.CronError(`Field (${i}) cannot be parsed`)}}};g.CronTime=I});var H=D(E=>{"use strict";var b=E&&E.__awaiter||function(c,e,i,n){function t(o){return o instanceof i?o:new i(function(h){h(o)})}return new(i||(i=Promise))(function(o,h){function s(l){try{r(n.next(l))}catch(a){h(a)}}function u(l){try{r(n.throw(l))}catch(a){h(a)}}function r(l){l.done?o(l.value):t(l.value).then(s,u)}r((n=n.apply(c,e||[])).next())})};Object.defineProperty(E,"__esModule",{value:!0});E.CronJob=void 0;var $=U("node:child_process"),x=A(),k=v(),N=class c{get isActive(){return this._isActive}get isCallbackRunning(){return this._isCallbackRunning}constructor(e,i,n,t,o,h,s,u,r,l,a){if(this.unrefTimeout=!1,this.lastExecution=null,this.runOnce=!1,this.waitForCompletion=!1,this._isActive=!1,this._isCallbackRunning=!1,this._callbacks=[],this.context=h??this,this.waitForCompletion=!!l,this.errorHandler=a,o!=null&&u!=null)throw new x.ExclusiveParametersError("timeZone","utcOffset");o!=null?this.cronTime=new k.CronTime(e,o,null):u!=null?this.cronTime=new k.CronTime(e,null,u):this.cronTime=new k.CronTime(e,o,u),r!=null&&(this.unrefTimeout=r),n!=null&&(this.onComplete=this._fnWrap(n)),this.cronTime.realDate&&(this.runOnce=!0),this.addCallback(this._fnWrap(i)),s&&(this.lastExecution=new Date,this.fireOnTick()),t&&this.start()}static from(e){if(e.timeZone!=null&&e.utcOffset!=null)throw new x.ExclusiveParametersError("timeZone","utcOffset");return e.timeZone!=null?new c(e.cronTime,e.onTick,e.onComplete,e.start,e.timeZone,e.context,e.runOnInit,e.utcOffset,e.unrefTimeout,e.waitForCompletion,e.errorHandler):e.utcOffset!=null?new c(e.cronTime,e.onTick,e.onComplete,e.start,null,e.context,e.runOnInit,e.utcOffset,e.unrefTimeout,e.waitForCompletion,e.errorHandler):new c(e.cronTime,e.onTick,e.onComplete,e.start,e.timeZone,e.context,e.runOnInit,e.utcOffset,e.unrefTimeout,e.waitForCompletion,e.errorHandler)}_fnWrap(e){var i,n;switch(typeof e){case"function":return e;case"string":{let[t,...o]=e.split(" ");return $.spawn.bind(void 0,t??e,o,{})}case"object":return $.spawn.bind(void 0,e.command,(i=e.args)!==null&&i!==void 0?i:[],(n=e.options)!==null&&n!==void 0?n:{})}}addCallback(e){typeof e=="function"&&this._callbacks.push(e)}setTime(e){if(!(e instanceof k.CronTime))throw new x.CronError("time must be an instance of CronTime.");let i=this._isActive;this.stop(),this.cronTime=e,e.realDate&&(this.runOnce=!0),i&&this.start()}nextDate(){return this.cronTime.sendAt()}fireOnTick(){return b(this,void 0,void 0,function*(){if(!(this.waitForCompletion&&this._isCallbackRunning)){this._isCallbackRunning=!0;try{for(let e of this._callbacks){let i=e.call(this.context,this.onComplete);this.waitForCompletion&&(yield i)}}catch(e){this.errorHandler!=null?this.errorHandler(e):console.error("[Cron] error in callback",e)}finally{this._isCallbackRunning=!1}}})}nextDates(e){return this.cronTime.sendAt(e??0)}start(){if(this._isActive)return;let e=2147483647,i=this.cronTime.getTimeout(),n=0,t,o=s=>{t=Date.now(),this._timeout=setTimeout(h,s),this.unrefTimeout&&typeof this._timeout.unref=="function"&&this._timeout.unref()},h=()=>{let s=t+i-Date.now();if(s>0){let u=this.cronTime.getTimeout();u>s&&(u=s),n+=u}n?(n>e?(n-=e,i=e):(i=n,n=0),o(i)):(this.lastExecution=new Date,this._isActive=!1,this.runOnce||this.start(),this.fireOnTick())};i>=0?(this._isActive=!0,i>e&&(n=i-e,i=e),o(i)):this.stop()}lastDate(){return this.lastExecution}_executeOnComplete(){return b(this,void 0,void 0,function*(){if(typeof this.onComplete=="function")try{yield this.onComplete.call(this.context)}catch(e){console.error("[Cron] error in onComplete callback:",e)}})}_waitForJobCompletion(){return b(this,void 0,void 0,function*(){for(;this._isCallbackRunning;)yield new Promise(e=>setTimeout(e,100))})}stop(){if(this._timeout&&clearTimeout(this._timeout),this._isActive=!1,!this.waitForCompletion){this._executeOnComplete();return}Promise.resolve().then(()=>b(this,void 0,void 0,function*(){yield this._waitForJobCompletion(),yield this._executeOnComplete()}))}};E.CronJob=N});var L=D(T=>{"use strict";Object.defineProperty(T,"__esModule",{value:!0});T.validateCronExpression=T.timeout=T.sendAt=T.CronTime=T.CronJob=void 0;var j=v(),X=H();Object.defineProperty(T,"CronJob",{enumerable:!0,get:function(){return X.CronJob}});var Q=v();Object.defineProperty(T,"CronTime",{enumerable:!0,get:function(){return Q.CronTime}});var ee=c=>new j.CronTime(c).sendAt();T.sendAt=ee;var te=c=>new j.CronTime(c).getTimeout();T.timeout=te;T.validateCronExpression=j.CronTime.validateCronExpression});var M=B(L()),{__esModule:ce,validateCronExpression:he,timeout:ae,sendAt:fe,CronTime:de,CronJob:me}=M,Te=M.default??M;export{me as CronJob,de as CronTime,ce as __esModule,Te as default,fe as sendAt,ae as timeout,he as validateCronExpression};
//# sourceMappingURL=cron.mjs.map