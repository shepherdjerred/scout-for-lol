VERSION 0.8
FROM ../../+deno

src:
  COPY src .
  SAVE ARTIFACT *

deps:
  WORKDIR /workspace/packages/data

  # download and cache dependencies
  CACHE --persist $DENO_DIR
  COPY --dir deno* src .
  RUN deno install --frozen=true --reload

# update Deno lockfile
lock:
  FROM ../../+deno
  COPY --dir deno.json .
  RUN deno install
  SAVE ARTIFACT deno.lock AS LOCAL deno.lock

check:
  FROM +deps
  CACHE $DENO_DIR
  RUN deno check src/index.ts
  RUN deno lint
  # RUN deno test -A --unstable
