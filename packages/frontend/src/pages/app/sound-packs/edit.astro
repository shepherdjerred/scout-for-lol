---
import AppLayout from "../../../layouts/app/AppLayout.astro";

const id = Astro.url.searchParams.get("id");
---

<AppLayout title="Edit Sound Pack">
  <div class="p-8" data-pack-id={id ?? ""}>
    <!-- Loading State -->
    <div id="loading-state" class="flex items-center justify-center py-12">
      <svg class="h-8 w-8 animate-spin text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
    </div>

    <!-- Content (hidden until loaded) -->
    <div id="content" class="hidden">
      <!-- Header -->
      <div class="mb-8 flex items-start justify-between">
        <div>
          <div class="flex items-center gap-3">
            <a href="/app/sound-packs" class="text-slate-400 hover:text-slate-300">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
              </svg>
            </a>
            <h1 class="text-3xl font-bold text-white" id="pack-name">Sound Pack</h1>
            <span id="pack-version" class="rounded bg-slate-800 px-2 py-1 text-xs text-slate-400">v1.0.0</span>
          </div>
          <p class="mt-2 text-slate-400" id="pack-description">No description</p>
        </div>
        <div class="flex items-center gap-3">
          <button
            id="export-btn"
            class="flex items-center gap-2 rounded-lg border border-slate-700 px-4 py-2 text-sm font-medium text-slate-300 transition-colors hover:bg-slate-800"
          >
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
            </svg>
            Export
          </button>
          <button
            id="save-btn"
            class="flex items-center gap-2 rounded-lg bg-indigo-500 px-4 py-2 text-sm font-medium text-white transition-colors hover:bg-indigo-600 disabled:cursor-not-allowed disabled:opacity-50"
          >
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
            <span id="save-text">Save Changes</span>
          </button>
        </div>
      </div>

      <!-- Tabs -->
      <div class="mb-6 border-b border-slate-800">
        <nav class="flex gap-6">
          <button class="tab-btn border-b-2 border-indigo-500 pb-3 text-sm font-medium text-white" data-tab="defaults">
            Default Sounds
          </button>
          <button class="tab-btn border-b-2 border-transparent pb-3 text-sm font-medium text-slate-400 hover:text-slate-300" data-tab="rules">
            Rules
          </button>
          <button class="tab-btn border-b-2 border-transparent pb-3 text-sm font-medium text-slate-400 hover:text-slate-300" data-tab="settings">
            Settings
          </button>
        </nav>
      </div>

      <!-- Default Sounds Tab -->
      <div id="tab-defaults" class="tab-content">
        <div class="mb-4 flex items-center justify-between">
          <p class="text-sm text-slate-400">Configure default sounds for each event type. These play when no custom rules match.</p>
        </div>
        <div class="space-y-4" id="defaults-list">
          <!-- Event type cards will be inserted here -->
        </div>
      </div>

      <!-- Rules Tab -->
      <div id="tab-rules" class="tab-content hidden">
        <div class="mb-4 flex items-center justify-between">
          <p class="text-sm text-slate-400">Custom rules let you play different sounds based on conditions like player names or champions.</p>
          <button
            id="add-rule-btn"
            class="flex items-center gap-2 rounded-lg bg-slate-800 px-4 py-2 text-sm font-medium text-slate-300 transition-colors hover:bg-slate-700"
          >
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
            Add Rule
          </button>
        </div>
        <div id="rules-empty" class="rounded-xl border border-slate-800 bg-slate-900/50 p-8 text-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-slate-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
          </svg>
          <p class="mt-4 text-slate-400">No custom rules yet</p>
          <p class="text-sm text-slate-500">Rules let you play specific sounds for certain players, champions, or events</p>
        </div>
        <div id="rules-list" class="hidden space-y-4">
          <!-- Rule cards will be inserted here -->
        </div>
      </div>

      <!-- Settings Tab -->
      <div id="tab-settings" class="tab-content hidden">
        <div class="max-w-2xl space-y-6">
          <div class="rounded-xl border border-slate-800 bg-slate-900/50 p-6">
            <h3 class="mb-4 font-semibold text-white">Audio Settings</h3>
            <div class="space-y-6">
              <div>
                <label for="masterVolume" class="mb-2 block text-sm font-medium text-slate-300">
                  Master Volume: <span id="volume-display">100%</span>
                </label>
                <input
                  type="range"
                  id="masterVolume"
                  min="0"
                  max="200"
                  value="100"
                  class="w-full"
                />
              </div>
              <div class="flex items-center gap-3">
                <input
                  type="checkbox"
                  id="normalization"
                  checked
                  class="h-4 w-4 rounded border-slate-700 bg-slate-800 text-indigo-500 focus:ring-indigo-500"
                />
                <div>
                  <label for="normalization" class="text-sm text-slate-300">Audio Normalization</label>
                  <p class="text-xs text-slate-500">Normalize audio levels to prevent clipping</p>
                </div>
              </div>
            </div>
          </div>

          <div class="rounded-xl border border-slate-800 bg-slate-900/50 p-6">
            <h3 class="mb-4 font-semibold text-white">Pack Information</h3>
            <div class="space-y-4">
              <div>
                <label for="edit-name" class="mb-2 block text-sm font-medium text-slate-300">Name</label>
                <input
                  type="text"
                  id="edit-name"
                  class="w-full rounded-lg border border-slate-700 bg-slate-800 px-4 py-2 text-white focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
                />
              </div>
              <div>
                <label for="edit-version" class="mb-2 block text-sm font-medium text-slate-300">Version</label>
                <input
                  type="text"
                  id="edit-version"
                  class="w-full rounded-lg border border-slate-700 bg-slate-800 px-4 py-2 text-white focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
                />
              </div>
              <div>
                <label for="edit-description" class="mb-2 block text-sm font-medium text-slate-300">Description</label>
                <textarea
                  id="edit-description"
                  rows="3"
                  class="w-full rounded-lg border border-slate-700 bg-slate-800 px-4 py-2 text-white focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
                ></textarea>
              </div>
              <div class="flex items-center gap-3">
                <input
                  type="checkbox"
                  id="edit-public"
                  class="h-4 w-4 rounded border-slate-700 bg-slate-800 text-indigo-500 focus:ring-indigo-500"
                />
                <label for="edit-public" class="text-sm text-slate-300">Make this sound pack public</label>
              </div>
            </div>
          </div>

          <div class="rounded-xl border border-red-500/30 bg-red-500/5 p-6">
            <h3 class="mb-4 font-semibold text-red-400">Danger Zone</h3>
            <div class="flex items-center justify-between">
              <div>
                <p class="font-medium text-white">Delete Sound Pack</p>
                <p class="text-sm text-slate-400">This action cannot be undone</p>
              </div>
              <button
                id="delete-btn"
                class="rounded-lg border border-red-500/50 px-4 py-2 text-sm font-medium text-red-400 transition-colors hover:bg-red-500/10"
              >
                Delete
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Error State -->
    <div id="error-state" class="hidden py-12 text-center">
      <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
      </svg>
      <p class="mt-4 text-lg font-medium text-white">Sound pack not found</p>
      <p class="mt-2 text-slate-400">The sound pack you're looking for doesn't exist or you don't have access to it.</p>
      <a href="/app/sound-packs" class="mt-6 inline-block rounded-lg bg-indigo-500 px-6 py-2 font-medium text-white hover:bg-indigo-600">
        Back to Sound Packs
      </a>
    </div>
  </div>
</AppLayout>

<script>
import { getApiClient } from "../../../lib/trpc";

const EVENT_TYPES = [
  { key: "gameStart", label: "Game Start", description: "When the game begins" },
  { key: "gameEnd", label: "Game End", description: "Victory or defeat" },
  { key: "firstBlood", label: "First Blood", description: "First kill of the game" },
  { key: "kill", label: "Kill", description: "When a champion is killed" },
  { key: "multiKill", label: "Multi-kill", description: "Double, triple, quadra, penta" },
  { key: "objective", label: "Objective", description: "Dragon, Baron, towers, etc." },
  { key: "ace", label: "Ace", description: "Team wipe" },
] as const;

interface SoundPack {
  dbId: number;
  id: string;
  name: string;
  version: string;
  description?: string | null;
  author?: string | null;
  settings: {
    masterVolume: number;
    normalization: boolean;
  };
  defaults: Record<string, { sounds: unknown[]; selectionMode: string } | undefined>;
  rules: Array<{
    id: string;
    name: string;
    enabled?: boolean;
    priority?: number;
    conditions: unknown[];
    conditionLogic?: string;
    sounds: unknown;
  }>;
}

let soundPack: SoundPack | null = null;
let hasUnsavedChanges = false;

// Get pack ID from URL
const packIdStr = document.querySelector("[data-pack-id]")?.getAttribute("data-pack-id");
const packId = packIdStr ? parseInt(packIdStr, 10) : null;

async function loadSoundPack() {
  if (!packId) {
    showError();
    return;
  }

  try {
    const client = getApiClient();
    soundPack = await client.soundPack.get.query({ id: packId });

    // Hide loading, show content
    document.getElementById("loading-state")?.classList.add("hidden");
    document.getElementById("content")?.classList.remove("hidden");

    // Populate UI
    populateUI();
  } catch (error) {
    console.error("Failed to load sound pack:", error);
    showError();
  }
}

function showError() {
  document.getElementById("loading-state")?.classList.add("hidden");
  document.getElementById("error-state")?.classList.remove("hidden");
}

function populateUI() {
  if (!soundPack) return;

  // Header
  const nameEl = document.getElementById("pack-name");
  const versionEl = document.getElementById("pack-version");
  const descEl = document.getElementById("pack-description");

  if (nameEl) nameEl.textContent = soundPack.name;
  if (versionEl) versionEl.textContent = `v${soundPack.version}`;
  if (descEl) descEl.textContent = soundPack.description ?? "No description";

  // Settings
  const volumeSlider = document.getElementById("masterVolume") as HTMLInputElement;
  const volumeDisplay = document.getElementById("volume-display");
  const normalization = document.getElementById("normalization") as HTMLInputElement;

  if (volumeSlider) {
    volumeSlider.value = String(Math.round(soundPack.settings.masterVolume * 100));
    if (volumeDisplay) volumeDisplay.textContent = `${volumeSlider.value}%`;
  }
  if (normalization) normalization.checked = soundPack.settings.normalization;

  // Edit fields
  const editName = document.getElementById("edit-name") as HTMLInputElement;
  const editVersion = document.getElementById("edit-version") as HTMLInputElement;
  const editDescription = document.getElementById("edit-description") as HTMLTextAreaElement;

  if (editName) editName.value = soundPack.name;
  if (editVersion) editVersion.value = soundPack.version;
  if (editDescription) editDescription.value = soundPack.description ?? "";

  // Render defaults
  renderDefaults();
  renderRules();
}

function renderDefaults() {
  const container = document.getElementById("defaults-list");
  if (!container || !soundPack) return;

  container.innerHTML = EVENT_TYPES.map(({ key, label, description }) => {
    const pool = soundPack?.defaults[key];
    const soundCount = pool?.sounds?.length ?? 0;

    return `
      <div class="rounded-xl border border-slate-800 bg-slate-900/50 p-6">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-4">
            <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-indigo-500/20">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-indigo-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
              </svg>
            </div>
            <div>
              <h3 class="font-medium text-white">${label}</h3>
              <p class="text-sm text-slate-400">${description}</p>
            </div>
          </div>
          <div class="flex items-center gap-4">
            <span class="text-sm text-slate-500">${soundCount} sound${soundCount !== 1 ? "s" : ""}</span>
            <button
              class="add-sound-btn rounded-lg bg-slate-800 px-3 py-1.5 text-sm text-slate-300 hover:bg-slate-700"
              data-event="${key}"
            >
              Add Sound
            </button>
          </div>
        </div>
        ${soundCount > 0 ? `
          <div class="mt-4 space-y-2">
            ${(pool?.sounds ?? []).map((sound: unknown, index: number) => {
              const s = sound as { id: string; source: { type: string; path?: string; url?: string }; volume: number };
              return `
                <div class="flex items-center justify-between rounded-lg bg-slate-800/50 px-4 py-2">
                  <span class="text-sm text-slate-300">${s.source.type === "file" ? s.source.path : s.source.url}</span>
                  <button class="remove-sound-btn text-slate-500 hover:text-red-400" data-event="${key}" data-index="${index}">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                  </button>
                </div>
              `;
            }).join("")}
          </div>
        ` : ""}
      </div>
    `;
  }).join("");

  // Add event listeners for add sound buttons
  document.querySelectorAll(".add-sound-btn").forEach((btn) => {
    btn.addEventListener("click", () => {
      const eventType = (btn as HTMLElement).dataset["event"];
      if (eventType) addSoundPrompt(eventType);
    });
  });

  // Add event listeners for remove sound buttons
  document.querySelectorAll(".remove-sound-btn").forEach((btn) => {
    btn.addEventListener("click", () => {
      const eventType = (btn as HTMLElement).dataset["event"];
      const index = parseInt((btn as HTMLElement).dataset["index"] ?? "0", 10);
      if (eventType) removeSound(eventType, index);
    });
  });
}

function renderRules() {
  const rulesEmpty = document.getElementById("rules-empty");
  const rulesList = document.getElementById("rules-list");

  if (!soundPack || soundPack.rules.length === 0) {
    rulesEmpty?.classList.remove("hidden");
    rulesList?.classList.add("hidden");
    return;
  }

  rulesEmpty?.classList.add("hidden");
  rulesList?.classList.remove("hidden");

  if (rulesList) {
    rulesList.innerHTML = soundPack.rules.map((rule: unknown, index: number) => {
      const r = rule as { id: string; name: string; enabled: boolean; priority: number; conditions: unknown[] };
      return `
        <div class="rounded-xl border border-slate-800 bg-slate-900/50 p-6">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-4">
              <input
                type="checkbox"
                class="rule-enabled h-4 w-4 rounded border-slate-700 bg-slate-800 text-indigo-500"
                data-index="${index}"
                ${r.enabled ? "checked" : ""}
              />
              <div>
                <h3 class="font-medium text-white">${escapeHtml(r.name)}</h3>
                <p class="text-sm text-slate-400">${r.conditions.length} condition${r.conditions.length !== 1 ? "s" : ""} | Priority: ${r.priority}</p>
              </div>
            </div>
            <button class="delete-rule-btn text-slate-500 hover:text-red-400" data-index="${index}">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
              </svg>
            </button>
          </div>
        </div>
      `;
    }).join("");
  }
}

function addSoundPrompt(eventType: string) {
  const url = prompt("Enter a YouTube URL or file path for the sound:");
  if (!url) return;

  if (!soundPack) return;

  // Initialize defaults for this event type if needed
  if (!soundPack.defaults[eventType]) {
    soundPack.defaults[eventType] = { sounds: [], selectionMode: "random" };
  }

  // Add the sound
  const source = url.includes("youtube.com") || url.includes("youtu.be")
    ? { type: "url" as const, url }
    : { type: "file" as const, path: url };

  (soundPack.defaults[eventType]!.sounds as unknown[]).push({
    id: crypto.randomUUID(),
    source,
    volume: 1,
    enabled: true,
  });

  hasUnsavedChanges = true;
  renderDefaults();
}

function removeSound(eventType: string, index: number) {
  if (!soundPack?.defaults[eventType]) return;

  (soundPack.defaults[eventType]!.sounds as unknown[]).splice(index, 1);
  hasUnsavedChanges = true;
  renderDefaults();
}

async function saveSoundPack() {
  if (!soundPack || !packId) return;

  const saveBtn = document.getElementById("save-btn") as HTMLButtonElement;
  const saveText = document.getElementById("save-text");

  saveBtn.disabled = true;
  if (saveText) saveText.textContent = "Saving...";

  try {
    // Get updated values from settings tab
    const editName = document.getElementById("edit-name") as HTMLInputElement;
    const editVersion = document.getElementById("edit-version") as HTMLInputElement;
    const editDescription = document.getElementById("edit-description") as HTMLTextAreaElement;
    const editPublic = document.getElementById("edit-public") as HTMLInputElement;
    const volumeSlider = document.getElementById("masterVolume") as HTMLInputElement;
    const normalization = document.getElementById("normalization") as HTMLInputElement;

    const client = getApiClient();
    // Use JSON round-trip to strip local TypeScript types and let tRPC/Zod validate
    const updateData = JSON.parse(JSON.stringify({
      name: editName?.value ?? soundPack.name,
      version: editVersion?.value ?? soundPack.version,
      description: editDescription?.value || null,
      isPublic: editPublic?.checked ?? false,
      settings: {
        masterVolume: parseInt(volumeSlider?.value ?? "100", 10) / 100,
        normalization: normalization?.checked ?? true,
      },
      defaults: soundPack.defaults,
      rules: soundPack.rules,
    })) as Parameters<typeof client.soundPack.update.mutate>[0]["data"];
    await client.soundPack.update.mutate({
      id: packId,
      data: updateData,
    });

    hasUnsavedChanges = false;

    // Update header
    const nameEl = document.getElementById("pack-name");
    const versionEl = document.getElementById("pack-version");
    if (nameEl && editName) nameEl.textContent = editName.value;
    if (versionEl && editVersion) versionEl.textContent = `v${editVersion.value}`;

    if (saveText) saveText.textContent = "Saved!";
    setTimeout(() => {
      if (saveText) saveText.textContent = "Save Changes";
    }, 2000);
  } catch (error) {
    console.error("Failed to save:", error);
    alert("Failed to save sound pack");
    if (saveText) saveText.textContent = "Save Changes";
  } finally {
    saveBtn.disabled = false;
  }
}

async function deleteSoundPack() {
  if (!confirm("Are you sure you want to delete this sound pack? This action cannot be undone.")) {
    return;
  }

  if (!packId) return;

  try {
    const client = getApiClient();
    await client.soundPack.delete.mutate({ id: packId });
    window.location.href = "/app/sound-packs";
  } catch (error) {
    console.error("Failed to delete:", error);
    alert("Failed to delete sound pack");
  }
}

async function exportSoundPack() {
  if (!packId) return;

  try {
    const client = getApiClient();
    const data = await client.soundPack.export.query({ id: packId });

    const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `${data.name.replace(/[^a-z0-9]/gi, "-").toLowerCase()}.json`;
    a.click();
    URL.revokeObjectURL(url);
  } catch (error) {
    console.error("Failed to export:", error);
    alert("Failed to export sound pack");
  }
}

function escapeHtml(str: string): string {
  const div = document.createElement("div");
  div.textContent = str;
  return div.innerHTML;
}

// Tab switching
document.querySelectorAll(".tab-btn").forEach((btn) => {
  btn.addEventListener("click", () => {
    const tab = (btn as HTMLElement).dataset["tab"];
    if (!tab) return;

    // Update button styles
    document.querySelectorAll(".tab-btn").forEach((b) => {
      b.classList.remove("border-indigo-500", "text-white");
      b.classList.add("border-transparent", "text-slate-400");
    });
    btn.classList.remove("border-transparent", "text-slate-400");
    btn.classList.add("border-indigo-500", "text-white");

    // Show/hide tab content
    document.querySelectorAll(".tab-content").forEach((content) => {
      content.classList.add("hidden");
    });
    document.getElementById(`tab-${tab}`)?.classList.remove("hidden");
  });
});

// Volume slider
const volumeSlider = document.getElementById("masterVolume") as HTMLInputElement;
const volumeDisplay = document.getElementById("volume-display");
volumeSlider?.addEventListener("input", () => {
  if (volumeDisplay) volumeDisplay.textContent = `${volumeSlider.value}%`;
  hasUnsavedChanges = true;
});

// Event listeners
document.getElementById("save-btn")?.addEventListener("click", saveSoundPack);
document.getElementById("delete-btn")?.addEventListener("click", deleteSoundPack);
document.getElementById("export-btn")?.addEventListener("click", exportSoundPack);

// Warn on unsaved changes
window.addEventListener("beforeunload", (e) => {
  if (hasUnsavedChanges) {
    e.preventDefault();
  }
});

// Load sound pack
loadSoundPack();
</script>
