---
description: Comprehensive guide comparing Mise and Dagger verification systems
globs: "*.ts,*.tsx,*.mjs,*.json,*.toml"
alwaysApply: true
---

# Mise and Dagger Usage Guide

This project uses two complementary systems for code verification:
- **Mise** - Fast local checks for development
- **Dagger** - CI environment checks for debugging

## Quick Reference

| Aspect | Mise | Dagger |
|--------|------|--------|
| **Use** | 95% of development | Debugging CI failures |
| **Speed** | 30-60 seconds | 2-5 minutes |
| **Environment** | Local machine | Docker container (CI-like) |
| **Best for** | Iteration, pre-commit | CI debugging, final verification |
| **Command** | `mise check` | `dagger call check` |

## Mise: Local Development (95% of the time)

### What Mise Does

Mise is a task runner that executes all code checks in parallel:

```
mise check
├── lint (ESLint + TypeScript ESLint rules)
├── typecheck (TypeScript compiler)
├── format (Prettier check, no auto-fix)
├── test (Bun test runner)
├── Knip (unused code detection)
└── JSCPD (copy-paste detection)
```

All run in parallel and complete in ~30-60 seconds.

### Installation & Setup

Mise should already be installed in your environment. Verify:

```bash
which mise
mise --version
```

If not installed, follow: https://mise.jd.dev/getting-started.html

### Running Checks

```bash
# Run all checks in parallel
mise check

# Run individual checks
mise run typecheck
mise run lint
mise run format
mise run test

# List all available tasks
mise tasks

# Watch mode for tests
bun test --watch
```

### Understanding Mise Output

When `mise check` completes:

#### ✅ All Green (0 errors, 0 warnings)

```
✓ Check all              completed successfully
```

You're ready to commit!

#### ❌ Errors (Stops at first category)

```
✗ Check all              failed

Error: lint failed
```

Look at the output above to see which check failed. See `code-quality-checklist.mdc` for how to fix each type of error.

### Mise vs bun run

Both work, but mise is preferred:

```bash
# ✅ Preferred (uses mise.toml configuration)
mise check
mise run typecheck
mise run lint

# ✅ Also works (direct bun/npm scripts)
bun run typecheck:all
bun run lint:all
bun run format:all

# Difference: mise runs tasks in parallel and can be configured per workspace
```

### Common Mise Tasks

**Root level commands:**

```bash
# Install all dependencies
mise run install:all

# Type check all packages
mise run typecheck

# Lint all files
mise run lint

# Format code
mise run format

# Run all tests
mise run test

# Check everything (same as mise check)
mise run check
```

**Per-package commands (cd into package first):**

```bash
cd packages/backend
mise run dev        # Development with hot reload
mise run build      # Build for production
mise run typecheck  # Type check this package only
mise run lint       # Lint this package only
mise run test       # Test this package only
```

## Dagger: CI Environment Debugging

### What Dagger Does

Dagger runs the same checks in a Docker container that mimics the CI environment:

```
dagger call check
├── lint (ESLint + TypeScript ESLint rules)
├── typecheck (TypeScript compiler)
├── format (Prettier check, no auto-fix)
├── test (Bun test runner)
└── (Other checks specific to CI)
```

Runs sequentially and takes ~2-5 minutes.

### When to Use Dagger

Use Dagger when:
1. ✅ `mise check` passes locally
2. ❌ CI (GitHub Actions) fails with an error
3. ❓ You can't figure out why

Then:
```bash
dagger call check

# Look for differences between mise output and dagger output
```

### Installation & Setup

Dagger should already be available. Verify:

```bash
which dagger
dagger version
```

If not installed: https://docs.dagger.io/install

### Running Checks

```bash
# Run the full CI check
dagger call check

# List available functions
dagger functions

# View specific function details
dagger functions --help

# Run specific target
dagger call ci --version="1.0.0" --git-sha="abc123"
```

### Available Dagger Targets

#### Main Verification

```bash
# Full code quality checks (lint, typecheck, test, format)
dagger call check

# Build all packages (no deployment)
dagger call build --version="1.0.0" --git-sha="abc123"

# Full CI pipeline (check + build)
dagger call ci --version="1.0.0" --git-sha="abc123"

# Deploy to environment
dagger call deploy --version="1.0.0" --stage="beta"
```

#### Package-Specific

```bash
# Check backend only
dagger call check-backend

# Build backend Docker image
dagger call build-backend-image --version="1.0.0" --git-sha="abc123"

# Generate Prisma client
dagger call generate-prisma

# Check report package
dagger call check-report

# Build report for npm distribution
dagger call build-report-for-npm --version="1.0.0"

# Check data package
dagger call check-data
```

### Understanding Dagger Output

#### ✅ All Green

```
... (long output)
✓ Check completed successfully
```

Same checks as mise passed in the CI environment.

#### ❌ Error (Shows full context)

```
Error: lint failed - custom-rules/no-type-assertions
  Line 42: Type assertions are not allowed...
```

This shows the exact error that's failing in CI.

### Debugging Differences

If `mise check` passes but `dagger call check` fails:

1. **Path differences** - Absolute vs relative paths
2. **Environment variables** - Missing or different values
3. **Permission issues** - File permissions in Docker
4. **Build artifacts** - Generated files not committed
5. **Node/Bun version** - Different runtimes

**Common fixes:**

```bash
# Clean and rebuild (fresh state)
rm -rf node_modules
mise run install:all

# Regenerate Prisma
cd packages/backend && bun run db:generate

# Check environment variables
env | grep -E "NODE_ENV|ENVIRONMENT|VERSION"

# Try dagger with verbose output
dagger call check --help
```

## Workflow Strategies

### Daily Development Workflow

1. **Make changes** to code
2. **Run `mise check`** to verify locally
3. **Fix errors** shown by mise
4. **Commit** when mise passes

```bash
# Your development loop
vim src/component.ts
mise check          # Takes 30-60s
# Fix errors
mise check          # Verify fixes
git add .
git commit -m "..."
```

### Pre-Commit Verification

Before committing, ensure:

```bash
# 1. Format code
bun run format:write

# 2. Run all checks
mise check

# 3. Commit only if all pass
git add .
git commit -m "Your message"
```

### Debugging CI Failures

When GitHub Actions fails but mise passes:

1. **Look at GitHub Actions error** - Note the exact error message
2. **Run `dagger call check`** locally to reproduce
3. **Compare environments:**
   - Check Node/Bun versions
   - Check environment variables
   - Check for uncommitted files
4. **Fix the issue** based on dagger output
5. **Run `mise check` + `dagger call check`** to verify both pass
6. **Push** when both pass

```bash
# Step-by-step debugging
echo "1. Check mise locally"
mise check

echo "2. CI failed? Run dagger"
dagger call check

echo "3. Compare the outputs"
# Look for differences in the two outputs

echo "4. Fix based on dagger output"
# Edit code

echo "5. Verify both pass"
mise check && dagger call check

echo "6. Commit"
git commit -m "..."
```

### Full Pre-Merge Verification

Before requesting code review:

```bash
# Run complete checks
mise check

# If working with database changes
cd packages/backend && bun run db:generate

# Lint and format everything
bun run lint:all
bun run format:write

# One more check to be sure
mise check

# Run dagger for CI-exact verification (optional but recommended)
dagger call check

# If all pass, you're ready for review
git push  # Don't forget - ask user before pushing!
```

## Environment Comparison

### Mise Environment

- **OS:** Your local machine
- **Node version:** Your installed version
- **Package manager:** Bun
- **Timezone:** Your timezone
- **Credentials:** Your environment variables
- **Paths:** Your absolute paths

### Dagger Environment

- **OS:** Ubuntu Linux (latest)
- **Node version:** Specified in Dockerfile
- **Package manager:** Bun
- **Timezone:** UTC
- **Credentials:** Passed via secrets (limited)
- **Paths:** Container paths (`/root`, `/workspace`)

### Why Differences Exist

If Dagger fails when mise passes, check:

1. **File encoding** - Windows (CRLF) vs Unix (LF)
2. **Path separators** - Backslash vs forward slash
3. **Environment variables** - Missing `DATABASE_URL`, `NODE_ENV`, etc.
4. **File permissions** - Executable vs regular files
5. **Git status** - Uncommitted changes
6. **Node modules** - Out of date or missing

**Fix most issues:**

```bash
# Ensure everything is clean and up to date
rm -rf node_modules dist build
bun install

# Run both checks
mise check
dagger call check
```

## Speed Comparison

### Mise (Local)

| Check | Time |
|-------|------|
| Lint | ~5-10s |
| Typecheck | ~10-15s |
| Format check | ~2-5s |
| Test | ~20-40s |
| Knip | ~5-10s |
| JSCPD | ~2-5s |
| **Total (parallel)** | **~30-60s** |

### Dagger (Docker)

| Phase | Time |
|-------|------|
| Docker setup | ~30-60s |
| Install dependencies | ~30-60s |
| Run checks | ~30-60s |
| Cleanup | ~10-20s |
| **Total** | **~2-5 minutes** |

### Recommendation

- **Development (inner loop):** Use mise (fast)
- **Pre-commit:** Use mise (fast enough)
- **CI debugging:** Use dagger (matches CI exactly)
- **Final verification:** Use both to be safe

## Key Principles

### Principle 1: Mise is Your Primary Tool

```bash
# Do this frequently
mise check

# Only do this when mise passes but CI fails
dagger call check
```

### Principle 2: Both Must Pass Before Push

```bash
# Before pushing:
mise check    # ✅ must pass
dagger call check  # ✅ strongly recommended

# Then push (with user approval)
```

### Principle 3: Fix Issues in Order

1. TypeScript errors first
2. ESLint errors second
3. Test failures third
4. Code quality issues fourth

See `code-quality-checklist.mdc` for the complete order.

### Principle 4: Trust the Tools

If the tools say there's an error, there's an error. Don't skip checks or suppress warnings—fix the root cause.

```bash
# ❌ DON'T do this
/* eslint-disable-next-line */ // Suppressing error without fixing

# ✅ DO this
// Fix the underlying issue, then the linter error goes away
```

## Quick Reference Sheet

### Commands Cheat Sheet

```bash
# Development (use daily)
mise check                 # All checks
mise run typecheck        # TypeScript only
mise run lint             # ESLint only
mise run test             # Tests only

# CI Debugging (use when mise passes but CI fails)
dagger call check         # Full CI checks
dagger functions          # List available dagger targets

# Formatting (auto-fix)
bun run format:write      # Fix formatting
mise run format           # Check formatting (no-fix)

# Database (backend changes)
cd packages/backend
bun run db:generate       # Generate Prisma client
bun run db:push           # Push schema to dev database
bun run db:studio         # Open Prisma Studio GUI
```

### When Things Go Wrong

| Symptom | Diagnosis | Fix |
|---------|-----------|-----|
| `mise check` hangs | Stuck process | `Ctrl+C`, check for `node_modules` corruption |
| Dagger timeout | Docker issue | Rebuild: `dagger engine restart` |
| Test failures | State not cleared | Ensure `beforeEach`/`afterEach` cleanup |
| ESLint errors persist | Cache issue | `bun run clean`, reinstall |
| TypeScript errors | Type mismatch | Validate with Zod, add null checks |
| Format conflicts | Line length | `bun run format:write` to auto-fix |

### Asking for Help

When asking for help with code quality issues:

1. **Run `mise check`** and share the error
2. **Run `dagger call check`** if mise passes but CI fails
3. **Include the exact error message** (copy-paste from terminal)
4. **Include the file name and line number**
5. **Reference the rule name** if known (e.g., "no-type-assertions")

See related rules:
- **For specific rule help:** See `eslint-custom-rules.mdc`
- **For overall quality checks:** See `code-quality-checklist.mdc`
- **For TypeScript help:** See `typescript-standards.mdc`
- **For Zod help:** See `zod-validation-patterns.mdc`

## Mise Configuration

Mise tasks are configured in:
- `mise.toml` (root level)
- Individual task definitions in `.mise/tasks/` directory

View configuration:

```bash
# Show all tasks
mise tasks

# Show specific task details
mise tasks --json | jq '.[0]'

# Edit mise configuration
cat mise.toml
```

## Dagger Configuration

Dagger functions are defined in:
- `.dagger/src/index.ts` - Main module

View available functions:

```bash
# List all functions
dagger functions

# Get help for specific function
dagger functions --help
dagger call check --help

# View source code
cat .dagger/src/index.ts
```

## Troubleshooting

### Issue: `mise check` passes but `dagger call check` fails

**Diagnosis:** Environment difference or missing generated files

**Solution:**

```bash
# 1. Ensure all generated code is up to date
cd packages/backend && bun run db:generate

# 2. Clean and reinstall
rm -rf node_modules
bun install

# 3. Run checks again
mise check
dagger call check
```

### Issue: Dagger is very slow

**Diagnosis:** Docker needs to download or rebuild

**Solution:**

```bash
# Restart docker daemon
dagger engine restart

# Or try again (it will use cache on second run)
dagger call check
```

### Issue: Tests pass locally but fail in Dagger

**Diagnosis:** Database setup issue or environment-specific state

**Solution:**

```bash
# Ensure test database cleanup
# Check afterEach in test file has await prisma.$disconnect()

# Check DATABASE_URL environment variable
echo $DATABASE_URL

# Run tests with specific environment
NODE_ENV=test bun test
```

### Issue: Type errors in Dagger but not in mise

**Diagnosis:** TypeScript cache or type-aware linting context

**Solution:**

```bash
# Clear TypeScript cache
rm -rf node_modules/.cache

# Regenerate
bun install
mise run typecheck
```

## See Also

- **Code Quality Checklist:** `code-quality-checklist.mdc`
- **Custom ESLint Rules:** `eslint-custom-rules.mdc`
- **TypeScript Standards:** `typescript-standards.mdc`
- **Testing Patterns:** `testing-patterns.mdc`
