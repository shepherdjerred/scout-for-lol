name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

# Only run on PRs from shepherdjerred
# This check is also enforced in the job condition below

permissions:
  contents: read
  pull-requests: write
  issues: write
  id-token: write

jobs:
  code-review:
    # Only run for PRs authored by shepherdjerred
    if: github.event.pull_request.user.login == 'shepherdjerred'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get CLAUDE.md content
        id: claude-md
        run: |
          if [ -f "CLAUDE.md" ]; then
            echo "content<<EOF" >> $GITHUB_OUTPUT
            cat CLAUDE.md >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "content=No CLAUDE.md found" >> $GITHUB_OUTPUT
          fi

      - name: Claude Code Review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          track_progress: true
          use_sticky_comment: true
          prompt: |
            You are a thorough code reviewer for the Scout for LoL project. Perform a comprehensive review of this pull request.

            ## Project Context

            This is a monorepo using Bun workspaces with the following packages:
            - backend: Discord bot service (Discord.js, Prisma, twisted for Riot API)
            - data: Shared data models, schemas, and utilities
            - report: Report generation (React + satori for image generation)
            - frontend: Web frontend (Astro + React + Tailwind)
            - desktop: Desktop app (Tauri + React + Vite)
            - ui: Shared UI components

            ## Review Guidelines from CLAUDE.md

            ${{ steps.claude-md.outputs.content }}

            ## Your Review Tasks

            ### 1. Architecture & Design Review
            - Does this change fit well within the existing architecture?
            - Are there concerns about the overall design approach?
            - Does this introduce unnecessary complexity or over-engineering?
            - Are there better patterns already established in the codebase that should be followed?

            ### 2. TypeScript & Type Safety
            - **CRITICAL**: Check for `any` types - these are strictly forbidden
            - **CRITICAL**: Check for type assertions (`as`) - these are forbidden by custom ESLint rules
            - Verify proper use of `unknown` with Zod validation for uncertain types
            - Check for proper null/undefined handling
            - Look for custom type guards (forbidden - use Zod instead)

            ### 3. Code Quality & Patterns
            - Verify Zod schemas are used for validation (with *Schema suffix)
            - Check that `remeda` is used for data transformations
            - Verify `ts-pattern` is used for complex branching
            - Check for proper error handling
            - Look for functions exceeding 400 lines, files exceeding 500 lines
            - Check cyclomatic complexity (max 20) and nesting depth (max 4)
            - Check for barrel file re-exports (forbidden)
            - Check for parent imports using `../` (forbidden)
            - Verify .ts extensions are used in imports

            ### 4. External Data Handling
            - Verify Raw* prefix is used for external/unvalidated data types (not *Dto)
            - Check that external API data is validated with Zod before use

            ### 5. Package-Specific Patterns
            - **Backend**: Check for `console.log` (use tslog instead), proper Discord error handling
            - **Report**: Check for satori best practices compliance
            - **Database**: Verify proper Prisma usage, transactions for multi-step operations

            ### 6. Security
            - Look for potential command injection, XSS, SQL injection risks
            - Check that sensitive data isn't being logged or exposed
            - Verify environment variables use `env-var` for type-safe access

            ### 7. Commit Quality
            - Review the PR title and commit messages
            - Are they descriptive and following conventions?
            - Do they explain the "why" not just the "what"?

            ## Output Format

            1. **Use inline comments** for specific code issues using the `mcp__github_inline_comment__create_inline_comment` tool. Be specific about:
               - The exact problem
               - Why it's a problem (reference CLAUDE.md guidelines when applicable)
               - A concrete suggestion for how to fix it

            2. **Post a summary comment** on the PR with:
               - Overall assessment (approve, request changes, or needs discussion)
               - Key findings organized by category
               - Architecture/design observations
               - Positive aspects of the PR (if any)
               - List of actionable items the author should address

            Be thorough but constructive. Reference specific lines and files. If the code looks good, say so - don't invent issues that don't exist.
