name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

# Only run on PRs from shepherdjerred
# This check is also enforced in the job condition below

permissions:
  contents: read
  pull-requests: write
  issues: write
  id-token: write

jobs:
  code-review:
    # Only run for PRs authored by shepherdjerred
    if: github.event.pull_request.user.login == 'shepherdjerred'
    runs-on: [scout-for-lol-runner-set]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - uses: 1password/load-secrets-action/configure@v3
        with:
          connect-host: http://onepassword-connect.1password.svc.cluster.local:8080
          connect-token: ${{ secrets.OP_CONNECT_TOKEN }}

      - uses: 1password/load-secrets-action@v3
        with:
          export-env: true
        env:
          CLAUDE_CODE_OAUTH_TOKEN: op://bic45kuflnwsnxnd67dzcnxjze/5p65mbzr237yyzt2sfnfao3a5a/CLAUDE_CODE_OAUTH_TOKEN

      - name: Get CLAUDE.md content
        id: claude-md
        run: |
          if [ -f "CLAUDE.md" ]; then
            echo "content<<EOF" >> $GITHUB_OUTPUT
            cat CLAUDE.md >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "content=No CLAUDE.md found" >> $GITHUB_OUTPUT
          fi

      - name: Claude Code Review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ env.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          track_progress: true
          use_sticky_comment: true
          prompt: |
            Review this PR for the Scout for LoL project. Focus on things linters and typecheckers can't catch.

            ## Project Guidelines (from CLAUDE.md)

            ${{ steps.claude-md.outputs.content }}

            ## Review Focus

            1. **Architecture fit** - Does this change fit the existing patterns? Is there a better approach already used in the codebase?
            2. **Logic and correctness** - Are there bugs, edge cases, or flawed assumptions?
            3. **Design concerns** - Is this over-engineered or under-engineered for the use case?
            4. **Naming and clarity** - Are names descriptive? Is the code self-documenting?
            5. **Commit quality** - Are commit messages clear and explaining "why" not just "what"?

            Don't flag issues that linters/typecheckers handle (type safety, import rules, formatting, etc.).

            Use inline comments for specific issues. Post a summary with your overall assessment and any actionable items. If the code looks good, say so.
